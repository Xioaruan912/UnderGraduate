<!DOCTYPE html>
<html lang="zh">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta http-equiv="Content-Language" content="zh-cn">
  <title>å¤šåŠŸèƒ½Markdownç”Ÿæˆå™¨</title>
  <style>
    body { font-family: "Microsoft Yahei", Consolas, monospace; margin: 20px; background: #fafafa; color: #333; }
    h2 { color: #444; margin-bottom: 8px; }
    .hint { margin: 6px 0 14px; color: #666; font-size: 13px; }
    .container { display: flex; gap: 10px; align-items: flex-start; }
    .box { flex: 1 1 0; display: flex; flex-direction: column; }
    label { font-weight: bold; margin-bottom: 5px; }
    textarea, select, input {
      display: block; width: 100%;
      padding: 10px; border: 2px solid #ccc; border-radius: 8px;
      resize: none; height: auto; min-height: 40px;
      transition: border-color 0.2s, background-color 0.2s;
      overflow: hidden;
      box-sizing: border-box;
      font-family: Consolas, "Microsoft Yahei", monospace;
    }
    textarea:focus, select:focus, input:focus { border-color: #007bff; background-color: #f0f8ff; outline: none; }
    .buttons { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; color: #fff; background: #007bff;
    }
    button.secondary { background: #6c757d; }
    button.warn { background: #dc3545; }
    button:hover { filter: brightness(0.95); }
    pre {
      background: #222; color: #0f0; padding: 15px; border-radius: 8px;
      white-space: pre-wrap; word-break: break-word;
      min-height: 180px; font-size: 14px; line-height: 1.4; overflow: auto;
      font-family: Consolas, "Microsoft Yahei", monospace;
      margin-top: 10px;
    }
    .badge { display:inline-block; background:#eee; color:#333; padding:2px 6px; border-radius:6px; font-size:12px; margin-left:6px;}
    .module { margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
    .preview { background: #fff; border: 1px solid #ddd; padding: 15px; margin-top: 20px; border-radius: 8px; }
    .preview pre { background: #f8f9fa; color: #333; border: 1px solid #eee; }
  </style>
</head>
<body>
  <h2>ğŸ“˜ Markdown å±‚çº§ç”Ÿæˆå™¨ï¼ˆé¡ºåºæ„å»ºç‰ˆÂ·å¯ç¼–è¾‘è¡Œï¼‰<span class="badge">æ”¯æŒåŒä¸€è¡Œå®æ—¶ç¼–è¾‘ + è‡ªåŠ¨ä¿å­˜</span></h2>
  <div class="hint">è§„åˆ™ï¼šæ¯ä¸ªè¾“å…¥æ¡†ä¸€è¡Œä¸€ä¸ªæ¡ç›®ï¼›åªåœ¨"æœ«å°¾è¿½åŠ "æ–°è¡Œä¼šæ–°å¢èŠ‚ç‚¹ï¼›åŒä¸€è¡Œåç»­ç¼–è¾‘ä¼šå®æ—¶æ›´æ–°æ–‡æœ¬ã€‚æ”¯æŒè‡ªåŠ¨ä¿å­˜ï¼Œåˆ·æ–°åå¯æ¢å¤ã€‚</div>

  <div class="container">
    <div class="box">
      <label>- # ä¸€çº§</label>
      <textarea id="lvl1" placeholder="ä¾‹ï¼šé½æ¬¡çº¿æ€§æ–¹ç¨‹ç»„"></textarea>
    </div>
    <div class="box">
      <label>- ## äºŒçº§</label>
      <textarea id="lvl2" placeholder="ä¾‹ï¼šå‘é‡å½¢å¼&#10;æœ‰è§£æ¡ä»¶"></textarea>
    </div>
    <div class="box">
      <label>- ### ä¸‰çº§</label>
      <textarea id="lvl3" placeholder="ä¾‹ï¼šå”¯ä¸€é›¶è§£&#10;éé›¶è§£"></textarea>
    </div>
    <div class="box">
      <label>- #### å››çº§</label>
      <textarea id="lvl4" placeholder="ä¾‹ï¼šæŸä¸ªå­ç»“è®º"></textarea>
    </div>
  </div>

  <div class="buttons">
    <button class="secondary" id="undoBtn">â†© æ’¤é”€ä¸€æ­¥</button>
    <button class="warn" id="resetBtn">ğŸ—‘ é‡ç½®</button>
    <button id="copyBtn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
  </div>

  <h3>å±‚çº§ç”Ÿæˆå™¨è¾“å‡ºç»“æœï¼š</h3>
  <pre id="output"></pre>

  <!-- æ–°å¢çš„æŠ˜å åˆ—è¡¨ç”Ÿæˆå™¨æ¨¡å— -->
  <div class="module">
    <h2>ğŸ“‹ æŠ˜å åˆ—è¡¨ç”Ÿæˆå™¨</h2>
    <div class="hint">è¾“å…¥æ¯ä¸ªåˆ—è¡¨é¡¹å†…å®¹ï¼Œé€‰æ‹©é¢œè‰²ï¼Œç”Ÿæˆå¯æŠ˜å çš„Markdownåˆ—è¡¨ã€‚</div>
    
    <div class="form-group">
      <label for="listItems">è¯·è¾“å…¥æ¯ä¸ª&lt;li&gt;é¡¹çš„å†…å®¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
      <textarea id="listItems" rows="6" placeholder="è¾“å…¥æ¯ä¸ª<li>é¡¹çš„å†…å®¹ï¼ŒæŒ‰å›è½¦åˆ†éš”..."></textarea>
    </div>

    <div class="form-group">
      <label for="colorSelect">é€‰æ‹©é¢œè‰²ï¼š</label>
      <select id="colorSelect">
        <option value="orange">æ©™è‰²</option>
        <option value="green">ç»¿è‰²</option>
        <option value="blue">è“è‰²</option>
        <option value="red">çº¢è‰²</option>
        <option value="purple">ç´«è‰²</option>
      </select>
    </div>

    <div class="buttons">
      <button onclick="generateMarkdown()">ç”ŸæˆæŠ˜å åˆ—è¡¨</button>
      <button onclick="copyMarkdownList()">ğŸ“‹ å¤åˆ¶æŠ˜å åˆ—è¡¨</button>
    </div>

    <div class="preview">
      <h3>æŠ˜å åˆ—è¡¨Markdownæºä»£ç ï¼š</h3>
      <pre id="markdownOutput"></pre>
    </div>
  </div>

  <script>
    // å±‚çº§ç”Ÿæˆå™¨ä»£ç 
    const header =
`ğŸŸ¨ ä¸å¤Ÿç†Ÿæ‚‰  âœ… ç†Ÿæ‚‰  âŒ å¿˜è®°  ğŸŸ¨-âœ… å¿˜è®°å¿«åˆ°è®°å¾—äº†

## å¤§é—®é¢˜
`;

    let eventOrder = [];
    let store = Object.create(null);
    let linesByLevel = { 1: [], 2: [], 3: [], 4: [] };

    const areas = {
      1: document.getElementById('lvl1'),
      2: document.getElementById('lvl2'),
      3: document.getElementById('lvl3'),
      4: document.getElementById('lvl4'),
    };

    // è‡ªé€‚åº”é«˜åº¦
    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    Object.values(areas).forEach(ta => autoResize(ta));

    function makeId(level){
      return `${level}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    function render() {
      let out = header;
      eventOrder.forEach(id => {
        const node = store[id];
        if (!node) return;
        const { level, text } = node;
        if (!text.trim()) return;
        if (level === 1) out += `- # ${text} âŒ\n`;
        else if (level === 2) out += `  - ## ${text} âŒ\n`;
        else if (level === 3) out += `    - ### ${text} âŒ\n`;
        else if (level === 4) out += `      - #### ${text} âŒ\n`;
      });
      document.getElementById('output').textContent = out;
      saveToLocal();
    }

    function onInput(level) {
      const ta = areas[level];
      autoResize(ta);

      const newLines = ta.value.replace(/\r/g,'').split('\n').filter(s => s !== '');
      const cur = linesByLevel[level];

      const minLen = Math.min(cur.length, newLines.length);

      for (let i=0; i<minLen; i++) {
        const newText = newLines[i];
        if (cur[i].text !== newText) {
          cur[i].text = newText;
          const id = cur[i].id;
          if (store[id]) store[id].text = newText;
        }
      }

      if (newLines.length < cur.length) {
        const removed = cur.slice(newLines.length);
        removed.forEach(item => {
          delete store[item.id];
          const idx = eventOrder.indexOf(item.id);
          if (idx >= 0) eventOrder.splice(idx, 1);
        });
        cur.length = newLines.length;
      }

      if (newLines.length > cur.length) {
        const added = newLines.slice(cur.length);
        added.forEach(text => {
          const id = makeId(level);
          const node = { level, text };
          store[id] = node;
          eventOrder.push(id);
          cur.push({ id, text });
        });
      }

      render();
    }

    function debounce(fn, delay=50) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }

    [1,2,3,4].forEach(level => {
      areas[level].addEventListener('input', () => autoResize(areas[level]));
      areas[level].addEventListener('input', debounce(() => onInput(level), 50));
    });

    document.getElementById('undoBtn').addEventListener('click', () => {
      if (!eventOrder.length) return;
      const id = eventOrder.pop();
      const node = store[id];
      if (node) {
        const level = node.level;
        const arr = linesByLevel[level];
        for (let i = arr.length - 1; i >= 0; i--) {
          if (arr[i].id === id) { arr.splice(i, 1); break; }
        }
        delete store[id];
        areas[level].value = linesByLevel[level].map(x => x.text).join('\n');
        autoResize(areas[level]);
      }
      render();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm("âš ï¸ é«˜å±æ“ä½œï¼šæ­¤æ“ä½œä¼šæ¸…ç©ºæ‰€æœ‰è¾“å…¥å’Œç»“æœï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) return;
      eventOrder = [];
      linesByLevel = { 1: [], 2: [], 3: [], 4: [] };
      store = Object.create(null);
      Object.values(areas).forEach(ta => {
        ta.value = '';
        autoResize(ta);
      });
      localStorage.removeItem("mdGeneratorData");
      render();
    });

    document.getElementById('copyBtn').addEventListener('click', async () => {
      const text = document.getElementById('output').textContent;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      } catch (e) {
        console.error('å¤åˆ¶å¤±è´¥ï¼š', e);
        alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
      }
    });

    window.addEventListener('beforeunload', (e) => {
      const hasContent = eventOrder.length > 0 || Object.values(areas).some(ta => ta.value.trim() !== '');
      if (hasContent) {
        e.preventDefault();
        e.returnValue = "âš ï¸ ä½ æœ‰æœªä¿å­˜çš„å†…å®¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ";
      }
    });

    function saveToLocal() {
      const data = {
        eventOrder,
        store,
        linesByLevel,
        textareas: Object.fromEntries(Object.entries(areas).map(([k, ta]) => [k, ta.value]))
      };
      localStorage.setItem("mdGeneratorData", JSON.stringify(data));
    }

    function loadFromLocal() {
      const raw = localStorage.getItem("mdGeneratorData");
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        eventOrder = data.eventOrder || [];
        store = data.store || Object.create(null);
        linesByLevel = data.linesByLevel || {1:[],2:[],3:[],4:[]};
        Object.entries(data.textareas || {}).forEach(([k,v]) => {
          if (areas[k]) {
            areas[k].value = v;
            autoResize(areas[k]);
          }
        });
      } catch(e) {
        console.warn("æ¢å¤å¤±è´¥:", e);
      }
    }

    loadFromLocal();
    render();

    // æŠ˜å åˆ—è¡¨ç”Ÿæˆå™¨åŠŸèƒ½
    function generateMarkdown() {
      const listItems = document.getElementById('listItems').value.split('\n').filter(item => item.trim() !== "");
      const color = document.getElementById('colorSelect').value;

      let markdown = `<details>
  <summary style="font-weight: bold; color: #007bff;">å±•å¼€ç­”æ¡ˆ</summary>
  <ul>`;

      listItems.forEach(item => {
        markdown += `    <li style="color: ${color};">${item}</li>\n`;
      });

      markdown += `  </ul>
</details>`;

      document.getElementById('markdownOutput').textContent = markdown;
    }

    function copyMarkdownList() {
      const markdownText = document.getElementById('markdownOutput').textContent;
      if (!markdownText.trim()) {
        alert("è¯·å…ˆç”ŸæˆæŠ˜å åˆ—è¡¨å†…å®¹ï¼");
        return;
      }
      
      navigator.clipboard.writeText(markdownText)
        .then(() => alert("æŠ˜å åˆ—è¡¨å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼"))
        .catch(err => {
          // å›é€€æ–¹æ¡ˆ
          const textarea = document.createElement('textarea');
          textarea.value = markdownText;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          alert("æŠ˜å åˆ—è¡¨å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
        });
    }

    // ä¸ºæŠ˜å åˆ—è¡¨ç”Ÿæˆå™¨çš„æ–‡æœ¬åŒºåŸŸæ·»åŠ è‡ªé€‚åº”é«˜åº¦
    const listItemsArea = document.getElementById('listItems');
    listItemsArea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });
  </script>
</body>
</html>