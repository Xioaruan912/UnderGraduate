<!DOCTYPE html>
<html lang="zh">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta http-equiv="Content-Language" content="zh-cn">
  <title>Markdown 层级生成器（顺序构建版·可编辑行）</title>
  <style>
    body { font-family: "Microsoft Yahei", Consolas, monospace; margin: 20px; background: #fafafa; color: #333; }
    h2 { color: #444; margin-bottom: 8px; }
    .hint { margin: 6px 0 14px; color: #666; font-size: 13px; }
    .container { display: flex; gap: 10px; }
    .box { flex: 1; display: flex; flex-direction: column; }
    label { font-weight: bold; margin-bottom: 5px; }
    textarea {
      flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px;
      resize: none; height: 120px; transition: border-color 0.2s, background-color 0.2s;
    }
    textarea:focus { border-color: #007bff; background-color: #f0f8ff; outline: none; }
    .buttons { margin-top: 10px; display: flex; gap: 8px; }
    button {
      padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; color: #fff; background: #007bff;
    }
    button.secondary { background: #6c757d; }
    button.warn { background: #dc3545; }
    button:hover { filter: brightness(0.95); }
    pre {
      background: #222; color: #0f0; padding: 15px; border-radius: 8px;
      white-space: pre-wrap; min-height: 180px; font-size: 14px; line-height: 1.4; overflow: auto;
      font-family: Consolas, "Microsoft Yahei", monospace;
      margin-top: 10px;
    }
    .badge { display:inline-block; background:#eee; color:#333; padding:2px 6px; border-radius:6px; font-size:12px; margin-left:6px;}
  </style>
</head>
<body>
  <h2>📘 Markdown 层级生成器（顺序构建版·可编辑行）<span class="badge">支持同一行实时编辑 + 自动保存</span></h2>
  <div class="hint">规则：每个输入框一行一个条目；只在“末尾追加”新行会新增节点；同一行后续编辑会实时更新文本。支持自动保存，刷新后可恢复。</div>

  <div class="container">
    <div class="box">
      <label>- # 一级</label>
      <textarea id="lvl1" placeholder="例：齐次线性方程组"></textarea>
    </div>
    <div class="box">
      <label>- ## 二级</label>
      <textarea id="lvl2" placeholder="例：向量形式&#10;有解条件"></textarea>
    </div>
    <div class="box">
      <label>- ### 三级</label>
      <textarea id="lvl3" placeholder="例：唯一零解&#10;非零解"></textarea>
    </div>
    <div class="box">
      <label>- #### 四级</label>
      <textarea id="lvl4" placeholder="例：某个子结论"></textarea>
    </div>
  </div>

  <div class="buttons">
    <button class="secondary" id="undoBtn">↩ 撤销一步</button>
    <button class="warn" id="resetBtn">🗑 重置</button>
    <button id="copyBtn">📋 复制结果</button>
  </div>

  <h3>输出结果：</h3>
  <pre id="output"></pre>

  <script>
    const header =
`🟨 不够熟悉  ✅ 熟悉  ❌ 忘记  🟨-✅ 忘记快到记得了

## 大问题
`;

    let eventOrder = [];
    let store = Object.create(null);
    let linesByLevel = { 1: [], 2: [], 3: [], 4: [] };

    const areas = {
      1: document.getElementById('lvl1'),
      2: document.getElementById('lvl2'),
      3: document.getElementById('lvl3'),
      4: document.getElementById('lvl4'),
    };

    function makeId(level){
      return `${level}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    function render() {
      let out = header;
      eventOrder.forEach(id => {
        const node = store[id];
        if (!node) return;
        const { level, text } = node;
        if (!text.trim()) return;
        if (level === 1) out += `- # ${text} ❌\n`;
        else if (level === 2) out += `  - ## ${text} ❌\n`;
        else if (level === 3) out += `    - ### ${text} ❌\n`;
        else if (level === 4) out += `      - #### ${text} ❌\n`;
      });
      document.getElementById('output').textContent = out;

      saveToLocal();
    }

    function onInput(level) {
      const ta = areas[level];
      const newLines = ta.value.replace(/\r/g,'').split('\n').filter(s => s !== '');
      const cur = linesByLevel[level];

      const minLen = Math.min(cur.length, newLines.length);

      // 更新已有行
      for (let i=0; i<minLen; i++) {
        const newText = newLines[i];
        if (cur[i].text !== newText) {
          cur[i].text = newText;
          const id = cur[i].id;
          if (store[id]) store[id].text = newText;
        }
      }

      // 删除多余行
      if (newLines.length < cur.length) {
        const removed = cur.slice(newLines.length);
        removed.forEach(item => {
          delete store[item.id];
          const idx = eventOrder.indexOf(item.id);
          if (idx >= 0) eventOrder.splice(idx, 1);
        });
        cur.length = newLines.length;
      }

      // 追加新行
      if (newLines.length > cur.length) {
        const added = newLines.slice(cur.length);
        added.forEach(text => {
          const id = makeId(level);
          const node = { level, text };
          store[id] = node;
          eventOrder.push(id);
          cur.push({ id, text });
        });
      }

      render();
    }

    // 去抖，避免 iPad 双输入
    function debounce(fn, delay=50) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }

    [1,2,3,4].forEach(level => {
      areas[level].addEventListener('input', debounce(() => onInput(level), 50));
    });

    // 撤销一步
    document.getElementById('undoBtn').addEventListener('click', () => {
      if (!eventOrder.length) return;
      const id = eventOrder.pop();
      const node = store[id];
      if (node) {
        const level = node.level;
        const arr = linesByLevel[level];
        for (let i = arr.length - 1; i >= 0; i--) {
          if (arr[i].id === id) { arr.splice(i, 1); break; }
        }
        delete store[id];
        areas[level].value = linesByLevel[level].map(x => x.text).join('\n');
      }
      render();
    });

    // 重置
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm("⚠️ 高危操作：此操作会清空所有输入和结果，确定要继续吗？")) return;
      eventOrder = [];
      linesByLevel = { 1: [], 2: [], 3: [], 4: [] };
      store = Object.create(null);
      Object.values(areas).forEach(ta => ta.value = '');
      localStorage.removeItem("mdGeneratorData");
      render();
    });

    // 复制
    document.getElementById('copyBtn').addEventListener('click', () => {
      const text = document.getElementById('output').textContent;
      navigator.clipboard.writeText(text).then(() => alert('✅ 已复制到剪贴板！'));
    });

    // 刷新提醒
    window.addEventListener('beforeunload', (e) => {
      const hasContent = eventOrder.length > 0 || Object.values(areas).some(ta => ta.value.trim() !== '');
      if (hasContent) {
        e.preventDefault();
        e.returnValue = "⚠️ 你有未保存的内容，确定要离开吗？";
      }
    });

    // 保存到 localStorage
    function saveToLocal() {
      const data = {
        eventOrder,
        store,
        linesByLevel,
        textareas: Object.fromEntries(Object.entries(areas).map(([k, ta]) => [k, ta.value]))
      };
      localStorage.setItem("mdGeneratorData", JSON.stringify(data));
    }

    // 从 localStorage 恢复
    function loadFromLocal() {
      const raw = localStorage.getItem("mdGeneratorData");
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        eventOrder = data.eventOrder || [];
        store = data.store || Object.create(null);
        linesByLevel = data.linesByLevel || {1:[],2:[],3:[],4:[]};
        Object.entries(data.textareas || {}).forEach(([k,v]) => {
          if (areas[k]) areas[k].value = v;
        });
      } catch(e) {
        console.warn("恢复失败:", e);
      }
    }

    loadFromLocal();
    render();
  </script>
</body>
</html>
